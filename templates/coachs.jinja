{% extends 'base.jinja' %}

{% block content %}
<div class="coachs-container">

    <div class="coachs-header">
        <h1>Nos Coachs Disponibles</h1>
        <p class="subtitle">Trouvez le coach parfait pour améliorer votre niveau de jeu</p>
    </div>


    <form method="get" action="{{ url_for('bd.rechercher_coachs') }}" class="search-bar mb-4">
        <div class="input-group">
            <input type="text" name="elem" class="form-control" placeholder="Recherche par nom ou courriel..."
                list="coach-list" value="{{ recherche }}">
            <button class="btn btn-primary" type="submit">Rechercher</button>
            <div id="suggestions-box" class="suggestions-box"></div>

        </div>
    </form>

    {% if coachs %}
    <div class="list-group shadow-sm">
        {% for coach in coachs %}
        <div class="list-group-item list-group-item-action d-flex align-items-center">
            <div class="me-3">
                {% if coach.image %}
                <img src="{{ url_for('static', filename=coach.image) }}" alt="{{ coach.user_name }}"
                    class="rounded-circle border border-success" width="60" height="60">
                {% else %}
                <div class="rounded-circle bg-success text-white d-flex justify-content-center align-items-center fw-bold"
                    style="width:60px; height:60px; font-size:1.5rem;">
                    {{ coach.user_name[0]|upper }}
                </div>
                {% endif %}

            </div>

            <div class="flex-grow-1">
                <p class="coach-name">
                    <a href="{{ url_for('compte.voir_profil', user_id=coach.id) }}"
                        class="text-decoration-none fw-bold text-dark">
                        {% if coach.est_supprime %}
                        Compte supprimé
                        {% else %}
                        {{ coach.user_name }}
                        {% endif %}

                    </a>
                </p>
                <p class="coach-email text-black"><strong>Courriel: </strong>{% if coach.est_supprime %}
                    Indisponible
                    {% else %}
                    {{ coach.courriel }}
                    {% endif %}</p>
                {% if coach.est_supprime %}
                <p><strong>Description: </strong>Utilisateur supprimé</p>
                {% else %}
                {% if coach.description %}
                <p><strong>Description: </strong>{{ coach.description }}</p>
                {% else %}
                <p class="text-muted">Aucune description disponible</p>
                {% endif %}
                {% endif %}

                {% if coach.jeux %}
                <div class="mt-2">
                    <strong>Jeux :</strong>
                    {% for jeu in coach.jeux %}
                    <span class="badge bg-secondary me-1">{{ jeu.nom }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="ms-3">
                {% if not coach.est_supprime %}
                <a href="{{ url_for('coach.demande_coach', coach_id=coach.id) }}"
                    class="btn btn-outline-success btn-sm">Demande</a>
                {% endif %}

            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        Aucun coach disponible pour le moment.
    </div>
    {% endif %}

</div>
<script>
const coachInput = document.getElementById("coach-search-input");
const coachSuggestionsBox = document.getElementById("coach-suggestions-box");

coachInput.addEventListener("input", async () => {
    const query = coachInput.value.trim();
    if (!query) {
        coachSuggestionsBox.innerHTML = "";
        coachSuggestionsBox.style.display = "none";
        return;
    }

    try {
        const response = await fetch(`/coachs/autocomplete_coach?query=${encodeURIComponent(query)}`);
        const suggestions = await response.json();

        if (suggestions.length === 0) {
            coachSuggestionsBox.innerHTML = `<div class="no-result">Aucun coach trouvé</div>`;
        } else {
            coachSuggestionsBox.innerHTML = suggestions
                .map(c => `<div data-id="${c.id}">${c.nom}</div>`).join("");
        }

        coachSuggestionsBox.style.display = "block";

        Array.from(coachSuggestionsBox.children).forEach(child => {
            child.addEventListener("click", () => {
                coachInput.value = child.textContent;
                coachSuggestionsBox.innerHTML = "";
                coachSuggestionsBox.style.display = "none";
                window.location.href = `/coachs?elem=${encodeURIComponent(child.textContent)}`;
            });
        });
    } catch(err) {
        console.error(err);
    }
});

document.addEventListener("click", (e) => {
    if (!coachSuggestionsBox.contains(e.target) && e.target !== coachInput) {
        coachSuggestionsBox.style.display = "none";
    }
});
</script>


{% endblock %}